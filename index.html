<script>
    // --- LÓGICA DE DADOS (CONECTADA À API VERCEL) ---
    let implants = [];
    let currentImageData = "";
    
    // Elementos UI
    const grid = document.getElementById('implantsGrid');
    const initialState = document.getElementById('initialState');
    const emptyState = document.getElementById('emptyState');
    const searchInput = document.getElementById('searchInput');
    const loadingIndicator = document.createElement('div'); // Indicador simples de loading

    // Configuração do Loading
    loadingIndicator.className = "text-center py-10 text-teal-600 font-bold hidden";
    loadingIndicator.innerHTML = '<i data-lucide="loader-2" class="w-8 h-8 animate-spin mx-auto mb-2"></i> Carregando base de dados...';
    grid.parentNode.insertBefore(loadingIndicator, grid);

    // 1. CARREGAR DADOS (GET)
    async function fetchImplants() {
        try {
            loadingIndicator.classList.remove('hidden');
            initialState.classList.add('hidden');
            
            const response = await fetch('/api/db');
            if (!response.ok) throw new Error('Falha na API');
            
            implants = await response.json();
            
            loadingIndicator.classList.add('hidden');
            handleSearch(); // Renderiza os dados
        } catch (error) {
            console.error("Erro:", error);
            loadingIndicator.innerHTML = "Erro ao carregar dados. Verifique a conexão.";
        }
    }

    // 2. SALVAR DADOS (POST)
    async function saveToCloud() {
        // Mostra feedback visual que está a salvar
        const saveBtn = document.querySelector('button[type="submit"]');
        const originalText = saveBtn.innerText;
        saveBtn.innerText = "SALVANDO...";
        saveBtn.disabled = true;

        try {
            const response = await fetch('/api/db', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(implants)
            });

            if (!response.ok) throw new Error('Erro ao salvar');
            
            alert('Dados sincronizados com sucesso!');
        } catch (error) {
            alert('Erro ao salvar na nuvem.');
            console.error(error);
        } finally {
            saveBtn.innerText = originalText;
            saveBtn.disabled = false;
        }
    }

    // --- MANIPULAÇÃO DE IMAGEM ---
    document.getElementById('imageUpload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        // Aviso: Gists têm limite de tamanho. Imagens grandes podem quebrar.
        // Idealmente, redimensione aqui ou use URLs externas.
        if (file && file.size > 1000000) { 
            alert("A imagem é muito grande para o Gist. Tente uma imagem menor que 1MB.");
            return;
        }

        const reader = new FileReader();
        reader.onloadend = () => {
            currentImageData = reader.result;
            document.getElementById('imagePreview').innerHTML = `<img src="${currentImageData}" class="w-full h-full object-cover">`;
        };
        if (file) reader.readAsDataURL(file);
    });

    // --- FUNÇÕES CRUD ---

    function handleSearch() {
        const term = searchInput.value.trim().toLowerCase();
        const cat = document.getElementById('categorySelect').value;

        // Se estiver vazio e for o carregamento inicial, mostra todos ou estado inicial
        if (implants.length === 0) {
             grid.classList.add('hidden');
             emptyState.classList.remove('hidden');
             return;
        }

        const filtered = implants.filter(imp => {
            const matchesText = imp.name.toLowerCase().includes(term) || 
                                imp.manufacturer.toLowerCase().includes(term) ||
                                (imp.modelRef && imp.modelRef.toLowerCase().includes(term));
            const matchesCat = cat === 'todos' || imp.category === cat;
            return matchesText && matchesCat;
        });

        renderGrid(filtered);
    }

    function renderGrid(data) {
        grid.classList.remove('hidden');
        grid.innerHTML = '';

        if (data.length === 0) {
            emptyState.classList.remove('hidden');
            return;
        }

        emptyState.classList.add('hidden');
        data.forEach(imp => {
            const card = document.createElement('div');
            card.className = `bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden hover:shadow-2xl hover:-translate-y-1 transition-all cursor-pointer group status-${imp.status}`;
            card.onclick = (e) => {
                if(!e.target.closest('button')) openDetailModal(imp.id);
            };
            
            card.innerHTML = `
                <div class="p-7">
                    <div class="flex justify-between items-start mb-4">
                        <span class="text-[9px] font-black uppercase tracking-widest px-3 py-1.5 rounded-full bg-slate-100 text-slate-500">${imp.category}</span>
                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="editImplant(${imp.id})" class="p-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                            <button onclick="deleteImplant(${imp.id})" class="p-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <h3 class="font-extrabold text-xl text-slate-800 mb-1 leading-tight group-hover:text-teal-600 transition-colors">${imp.name}</h3>
                    <p class="text-slate-400 text-[11px] font-bold uppercase mb-6">${imp.manufacturer} | ${imp.modelRef || 'REF N/A'}</p>
                    
                    <div class="flex items-center justify-between pt-5 border-t border-slate-50">
                        <div class="flex items-center gap-2">
                            <div class="w-2.5 h-2.5 rounded-full ${imp.status === 'Safe' ? 'bg-green-500' : imp.status === 'Conditional' ? 'bg-amber-500' : 'bg-red-500'}"></div>
                            <span class="text-[11px] font-black text-slate-600 uppercase tracking-tighter italic">MRI ${imp.status}</span>
                        </div>
                        <i data-lucide="chevron-right" class="w-5 h-5 text-slate-200 group-hover:text-teal-500 transition-all group-hover:translate-x-1"></i>
                    </div>
                </div>
            `;
            grid.appendChild(card);
        });
        lucide.createIcons();
    }

    document.getElementById('implantForm').onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById('editId').value;
        const newImplant = {
            id: id ? parseInt(id) : Date.now(),
            name: document.getElementById('name').value,
            manufacturer: document.getElementById('manufacturer').value,
            modelRef: document.getElementById('modelRef').value,
            status: document.getElementById('status').value,
            category: document.getElementById('category').value,
            fieldStrength: document.getElementById('fieldStrength').value,
            sarLimit: document.getElementById('sarLimit').value,
            gradientLimit: document.getElementById('gradientLimit').value,
            waitPeriod: document.getElementById('waitPeriod').value,
            specificConditions: document.getElementById('specificConditions').value,
            refUrl: document.getElementById('refUrl').value,
            image: currentImageData
        };

        if (id) {
            const index = implants.findIndex(i => i.id === parseInt(id));
            implants[index] = newImplant;
        } else {
            implants.push(newImplant);
        }

        // Alteração Principal: Salvar na Cloud
        await saveToCloud();
        
        closeFormModal();
        handleSearch();
    };

    async function deleteImplant(id) {
        if (confirm('Eliminar este registo técnico permanentemente?')) {
            implants = implants.filter(i => i.id !== id);
            await saveToCloud(); // Atualiza a cloud
            handleSearch();
        }
    }

    function editImplant(id) {
        const imp = implants.find(i => i.id === id);
        document.getElementById('editId').value = imp.id;
        document.getElementById('name').value = imp.name;
        document.getElementById('manufacturer').value = imp.manufacturer;
        document.getElementById('modelRef').value = imp.modelRef;
        document.getElementById('status').value = imp.status;
        document.getElementById('category').value = imp.category;
        document.getElementById('fieldStrength').value = imp.fieldStrength;
        document.getElementById('sarLimit').value = imp.sarLimit;
        document.getElementById('gradientLimit').value = imp.gradientLimit;
        document.getElementById('waitPeriod').value = imp.waitPeriod;
        document.getElementById('specificConditions').value = imp.specificConditions;
        document.getElementById('refUrl').value = imp.refUrl;
        currentImageData = imp.image || "";
        
        if(currentImageData) {
            document.getElementById('imagePreview').innerHTML = `<img src="${currentImageData}" class="w-full h-full object-cover">`;
        }

        document.getElementById('modalTitle').innerText = "Editar Registo Técnico";
        openFormModal();
    }

    // Funções Modais (UI)
    function openFormModal() { document.getElementById('formModal').classList.replace('hidden', 'flex'); }
    function closeFormModal() {
        document.getElementById('formModal').classList.replace('flex', 'hidden');
        document.getElementById('implantForm').reset();
        document.getElementById('editId').value = "";
        document.getElementById('modalTitle').innerText = "Registrar Novo Dispositivo";
        document.getElementById('imagePreview').innerHTML = `<i data-lucide="image" class="w-10 h-10"></i>`;
        currentImageData = "";
        lucide.createIcons();
    }

    function openDetailModal(id) {
        const imp = implants.find(i => i.id === id);
        const content = document.getElementById('detailContent');
        const statusColor = imp.status === 'Safe' ? 'text-green-600' : imp.status === 'Conditional' ? 'text-amber-600' : 'text-red-600';
        
        content.innerHTML = `
            <div class="relative h-64 bg-slate-900 flex items-center justify-center overflow-hidden">
                ${imp.image ? `<img src="${imp.image}" class="w-full h-full object-cover opacity-50 blur-[2px]">` : `<div class="absolute inset-0 bg-gradient-to-br from-teal-900 to-blue-900 opacity-60"></div>`}
                <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-slate-900/40 to-transparent"></div>
                <button onclick="closeDetailModal()" class="absolute top-6 right-6 p-2 bg-white/10 hover:bg-white/20 rounded-full text-white backdrop-blur-md transition-all"><i data-lucide="x"></i></button>
                <div class="absolute bottom-8 left-10 right-10">
                    <span class="text-[10px] font-black text-teal-400 uppercase tracking-[0.3em] mb-2 block">${imp.category}</span>
                    <h2 class="text-4xl font-extrabold text-white leading-tight">${imp.name}</h2>
                </div>
            </div>
            <div class="p-10">
                <div class="flex flex-wrap gap-10 mb-10 border-b border-slate-100 pb-8">
                    <div><p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Fabricante</p><p class="font-extrabold text-slate-700 text-lg">${imp.manufacturer}</p></div>
                    <div><p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Modelo / REF</p><p class="font-extrabold text-slate-700 text-lg">${imp.modelRef || '---'}</p></div>
                    <div><p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Segurança RM</p><p class="font-black ${statusColor} text-lg uppercase italic">MRI ${imp.status}</p></div>
                </div>
                <div class="grid grid-cols-2 gap-y-8 gap-x-12 mb-10">
                    <div><div class="flex items-center gap-2 mb-1 text-teal-600"><i data-lucide="magnet" class="w-4 h-4"></i><p class="text-[10px] font-black uppercase tracking-widest">Campo Estático</p></div><p class="text-base text-slate-600 font-bold">${imp.fieldStrength || 'Não especificado'}</p></div>
                    <div><div class="flex items-center gap-2 mb-1 text-teal-600"><i data-lucide="activity" class="w-4 h-4"></i><p class="text-[10px] font-black uppercase tracking-widest">Limite SAR</p></div><p class="text-base text-slate-600 font-bold">${imp.sarLimit || 'Normal Mode'}</p></div>
                    <div><div class="flex items-center gap-2 mb-1 text-teal-600"><i data-lucide="zap" class="w-4 h-4"></i><p class="text-[10px] font-black uppercase tracking-widest">Gradiente Espacial</p></div><p class="text-base text-slate-600 font-bold">${imp.gradientLimit || '---'}</p></div>
                    <div><div class="flex items-center gap-2 mb-1 text-teal-600"><i data-lucide="clock" class="w-4 h-4"></i><p class="text-[10px] font-black uppercase tracking-widest">Período de Espera</p></div><p class="text-base text-slate-600 font-bold">${imp.waitPeriod || 'Imediato'}</p></div>
                </div>
                <div class="bg-slate-50 p-6 rounded-[1.5rem] border border-slate-100 mb-8">
                    <p class="text-[10px] font-black text-slate-400 uppercase mb-3 tracking-widest">Observações Técnicas Cruciais</p>
                    <p class="text-sm text-slate-700 leading-relaxed font-medium">${imp.specificConditions || 'Sem notas técnicas adicionais.'}</p>
                </div>
                ${imp.refUrl ? `<a href="${imp.refUrl}" target="_blank" class="flex items-center justify-center gap-3 w-full py-4 bg-teal-600 hover:bg-teal-700 text-white rounded-2xl text-xs font-black tracking-widest transition-all shadow-lg shadow-teal-100 uppercase"><i data-lucide="external-link" class="w-4 h-4"></i> Verificar Fonte Original</a>` : ''}
            </div>
        `;
        document.getElementById('detailModal').classList.replace('hidden', 'flex');
        lucide.createIcons();
    }
    function closeDetailModal() { document.getElementById('detailModal').classList.replace('flex', 'hidden'); }

    // INICIALIZAÇÃO
    searchInput.addEventListener('input', handleSearch);
    lucide.createIcons();
    
    // Iniciar carregando os dados da nuvem
    fetchImplants();
</script>